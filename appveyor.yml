image: Visual Studio 2015

environment:
  matrix:
  - JOB_NAME: test
    JOB_DESC: "the one that should run every time"

  - JOB_NAME: release
    JOB_DESC: "the one that should run on the release branch"

  - JOB_NAME: nightly
    JOB_DESC: "the one that should run on the nightly tag"

  - JOB_NAME: extra
    JOB_DESC: "the one that should only run by request"

for:
-
  branches:
    only:
      - /^release.*/
  matrix:
    only:
      - JOB_NAME: release
      - JOB_NAME: extra

-
  branches:
    only:
      - nightly
  matrix:
    only:
      - JOB_NAME: nightly

-
  only_commits:
    message: /\[full ci\]/
  matrix:
    only:
      - JOB_NAME: extra


branches:
  only:
    - master
    - /^release.*/
    - /^feat.*/
    - nightly

build_script:
- ps: >-
    if ($env:JOB_NAME -eq "extra") {
      # job will start on any release branch build, but it should only run on tags or by request
      Write-Host "is commit message like '*`[full ci`]*'?" ($env:APPVEYOR_REPO_COMMIT_MESSAGE -like '*`[full ci`]*');
      if (-not (($env:APPVEYOR_REPO_TAG -like 'True') -or ($env:APPVEYOR_REPO_COMMIT_MESSAGE -like '*`[full ci`]*'))) {
        Write-Host "Not a release candidate and full ci was not requested, bailing.";
        Exit-AppveyorBuild;
      }
    }

- ps: Write-Host "Running $env:JOB_NAME job ($env:JOB_DESC).";
